#!/usr/bin/env python3

import sys
import os
import io
import importlib

# Try both possible import paths
try:
    from inspectors.utils import utils, admin
except ImportError:
    from inspectors import utils, admin


def find_scripts_dir():
    cwd = os.getcwd()
    scripts_dir = os.path.join(cwd, "scripts")

    if os.path.isdir(scripts_dir):
        return scripts_dir

    qa_dir = os.path.dirname(os.path.abspath(sys.argv[0]))
    scripts_dir = os.path.join(qa_dir, "scripts")

    if os.path.isdir(scripts_dir):
        return scripts_dir

    print(
        "Could not find the scripts directory. "
        "Run this from the same directory where 'qa' is located."
    )
    sys.exit(1)


def get_script_names(scripts_dir):
    scripts = []
    for file in os.listdir(scripts_dir):
        path = os.path.join(scripts_dir, file)
        if os.path.isfile(path) and file.endswith(".py"):
            scripts.append(os.path.splitext(file)[0])
    scripts.sort()
    return scripts


def print_help(script_names):
    joined = ",".join(script_names)
    print(
        f"Usage: qa {{all,{joined}}} "
        "[--only=dod,epa,gao,nasa,...] "
        "[--safe] [--help] [-h]"
    )


def main():
    scripts_dir = find_scripts_dir()
    sys.path.insert(0, scripts_dir)

    script_names = get_script_names(scripts_dir)
    opts = utils.options()

    # âœ… Support both --help and -h
    if "help" in opts or "--help" in sys.argv or "-h" in sys.argv:
        print_help(script_names)
        sys.exit(0)

    # Inspector list
    if "safe" in opts:
        ig_list = utils.safe_igs()
    elif "only" in opts:
        ig_list = opts["only"].split(",")
    else:
        ig_list = []

    run_all = "all" in sys.argv
    ran_any = False
    successful = True
    total_report = ""

    for script_name in script_names:
        if run_all or script_name in sys.argv:
            ran_any = True
            print(f"Running {script_name}...")

            try:
                module = importlib.import_module(script_name)
                if not hasattr(module, "run"):
                    raise AttributeError("Missing run() function")

                # Capture stdout
                saved_stdout = sys.stdout
                buffer = io.StringIO()
                sys.stdout = buffer

                utils.run(module.run, {"inspectors": ig_list})

                sys.stdout = saved_stdout
                output = buffer.getvalue()

                if output.strip():
                    total_report += (
                        f"QA results for `{script_name}`:\n\n{output}\n\n"
                    )
                    successful = False

            except Exception as e:
                sys.stdout = sys.__stdout__
                total_report += (
                    f"QA crashed in `{script_name}`:\n{e}\n\n"
                )
                successful = False

    if not ran_any:
        print_help(script_names)
        sys.exit(1)

    if successful:
        sys.exit(0)
    else:
        admin.log_qa(total_report)
        sys.exit(1)


if __name__ == "__main__":
    main()
